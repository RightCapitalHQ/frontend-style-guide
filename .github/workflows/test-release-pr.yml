name: Test Release PR

on:
  workflow_dispatch:
    inputs:
      cleanup:
        description: 'Auto-close test PR and delete branch after validation'
        type: boolean
        default: true
      dry_run_release:
        description: 'Also run nx release --dry-run to validate full release logic'
        type: boolean
        default: false

jobs:
  test-release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.REPO_AUTOMATION_TOKEN }}

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version-file: .node-version
          cache: pnpm

      - run: pnpm install

      - uses: ./.github/actions/nx-release-pr
        id: release-pr
        with:
          branch: test-release
          base: ${{ github.ref_name }}
          pr-title: '[TEST] chore(release): release packages'
          commit-message: 'chore(release): prepare release [TEST]'
          banner: |
            > [!WARNING]
            > **This is a TEST release PR. Do not merge.**
            > Created by `test-release-pr.yml` workflow to validate release PR logic.
          token: ${{ secrets.REPO_AUTOMATION_TOKEN }}

      - name: Validation summary
        run: |
          echo "## Test Release PR Validation Summary"
          echo ""
          echo "PR URL: ${{ steps.release-pr.outputs.pr-url }}"
          echo "Target branch: ${{ github.ref_name }}"
          echo "Source branch: test-release"
          echo ""
          echo "### Branch check"
          git ls-remote --heads origin test-release
          echo ""
          echo "### PR body preview"
          cat pr-body.md

      - name: Dry-run version
        if: inputs.dry_run_release
        run: pnpm exec nx release version --dry-run

  cleanup:
    needs: test-release-pr
    if: always() && inputs.cleanup
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6

      - name: Close test PR
        run: |
          pr_number=$(gh pr list --head test-release --json number --jq '.[0].number // empty')
          if [ -n "$pr_number" ]; then
            gh pr comment "$pr_number" --body "Automatically closing test release PR. Validation complete."
            gh pr close "$pr_number"
            echo "Closed PR #$pr_number"
          else
            echo "No test release PR found to close"
          fi
        env:
          GH_TOKEN: ${{ secrets.REPO_AUTOMATION_TOKEN }}

      - name: Delete test-release branch
        run: |
          if git ls-remote --heads origin test-release | grep -q test-release; then
            git push origin --delete test-release
            echo "Deleted remote branch test-release"
          else
            echo "Branch test-release does not exist on remote"
          fi
        env:
          GH_TOKEN: ${{ secrets.REPO_AUTOMATION_TOKEN }}
