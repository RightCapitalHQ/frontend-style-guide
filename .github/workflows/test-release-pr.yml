name: Test Release PR

on:
  workflow_dispatch:
    inputs:
      cleanup:
        description: 'Auto-close test PR and delete branch after validation'
        type: boolean
        default: true
      dry_run_release:
        description: 'Also run nx release --dry-run to validate full release logic'
        type: boolean
        default: false

jobs:
  test-release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.REPO_AUTOMATION_TOKEN }}

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version-file: .node-version
          cache: pnpm

      - run: pnpm install

      - name: Configure Git
        run: |
          git config user.email "npm-publisher@rightcapital.com"
          git config user.name "GitHub Actions[bot]"

      - name: Check for existing test release PR
        id: check-pr
        run: |
          pr_number=$(gh pr list --head test-release --json number --jq '.[0].number // empty')
          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create or update test-release branch
        run: |
          git checkout -B test-release

          # Run version bump (updates package.json versions, changelogs)
          pnpm exec nx release version

          # Update lock file after version bumps
          pnpm install --no-frozen-lockfile

          git add .
          git commit -m "chore(release): prepare release [TEST]" || echo "No changes to commit"
          git push origin test-release --force

      - name: Generate PR body
        run: |
          {
            echo "> [!WARNING]"
            echo "> **This is a TEST release PR. Do not merge.**"
            echo "> Created by \`test-release-pr.yml\` workflow to validate release PR logic."
            echo ""
            echo "## Release Summary"
            echo ""
            echo "This PR will release the following packages when merged:"
            echo ""
            # Show pending version changes
            pnpm exec nx release version --dry-run 2>&1 | grep -E "(UPDATE|Skipping)" || true
            echo ""
            echo "---"
            echo ""
            echo "### Version Plans Included"
            echo ""
            find .nx/version-plans -name '*.md' -type f 2>/dev/null | while read -r f; do
              echo "#### $(basename "$f")"
              cat "$f"
              echo ""
            done
          } > pr-body.md

      - name: Create or update PR
        id: create-pr
        run: |
          if [ -z "${{ steps.check-pr.outputs.pr_number }}" ]; then
            pr_url=$(gh pr create \
              --base "${{ github.ref_name }}" \
              --head test-release \
              --title "[TEST] chore(release): release packages" \
              --body-file pr-body.md \
              --label "release")
            echo "pr_url=$pr_url" >> "$GITHUB_OUTPUT"
          else
            gh pr edit ${{ steps.check-pr.outputs.pr_number }} \
              --body-file pr-body.md
            pr_url=$(gh pr view ${{ steps.check-pr.outputs.pr_number }} --json url --jq '.url')
            echo "pr_url=$pr_url" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ secrets.REPO_AUTOMATION_TOKEN }}

      - name: Validation summary
        run: |
          echo "## Test Release PR Validation Summary"
          echo ""
          echo "PR URL: ${{ steps.create-pr.outputs.pr_url }}"
          echo "Target branch: ${{ github.ref_name }}"
          echo "Source branch: test-release"
          echo ""
          echo "### Branch check"
          git ls-remote --heads origin test-release
          echo ""
          echo "### PR body preview"
          cat pr-body.md

      - name: Dry-run version
        if: inputs.dry_run_release
        run: pnpm exec nx release version --dry-run

  cleanup:
    needs: test-release-pr
    if: always() && inputs.cleanup
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6

      - name: Close test PR
        run: |
          pr_number=$(gh pr list --head test-release --json number --jq '.[0].number // empty')
          if [ -n "$pr_number" ]; then
            gh pr comment "$pr_number" --body "Automatically closing test release PR. Validation complete."
            gh pr close "$pr_number"
            echo "Closed PR #$pr_number"
          else
            echo "No test release PR found to close"
          fi
        env:
          GH_TOKEN: ${{ secrets.REPO_AUTOMATION_TOKEN }}

      - name: Delete test-release branch
        run: |
          if git ls-remote --heads origin test-release | grep -q test-release; then
            git push origin --delete test-release
            echo "Deleted remote branch test-release"
          else
            echo "Branch test-release does not exist on remote"
          fi
        env:
          GH_TOKEN: ${{ secrets.REPO_AUTOMATION_TOKEN }}
